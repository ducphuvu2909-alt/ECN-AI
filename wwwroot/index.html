<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ECN Manager — Đăng nhập</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:#fff}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff;z-index:10}
    .brand{font-weight:700}
    .spacer{flex:1}
    .userpill{font-size:14px;opacity:.85}
    .wrap{display:flex;justify-content:center}
    .box{width:100%;max-width:520px;padding:20px}
    h2{margin:16px 0 8px 0}
    label{display:block;margin-top:12px;font-size:14px}
    input,select{width:100%;padding:12px;border:1px solid #ccc;border-radius:10px;margin-top:6px;font-size:15px}
    .btn{display:inline-block;padding:12px 16px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;margin-top:14px;cursor:pointer}
    .note{font-size:12px;opacity:.75;margin-top:8px}
    .err{color:#b00020}
    .ok{color:#0a7b28}
  </style>
</head>
<body>
  <header>
    <div class="brand">ECN Manager</div>
    <div class="spacer"></div>
    <div id="userpill" class="userpill"></div>
    <button id="btnLogout" class="btn" style="display:none;background:#f5f5f5;color:#111;border-color:#ddd">Đăng xuất</button>
  </header>

  <div class="wrap">
    <div class="box">
      <h2>Đăng nhập</h2>
      <label>Tài khoản</label>
      <input id="loginUser" placeholder="email hoặc ID"/>
      <label>Mật khẩu</label>
      <input id="loginPass" type="password" placeholder="•••••••"/>
      <label>Department</label>
      <select id="loginDept">
        <option value="">(Auto từ server)</option>
        <option>SMT</option><option>DIP</option><option>FE</option><option>PE</option><option>QC</option><option>COS</option>
      </select>
      <button id="btnLogin" class="btn">Vào hệ thống</button>
      <div id="loginMsg" class="note"></div>
      <div class="note">Bản production: xác thực JWT từ server ASP.NET Core (.NET 8).</div>
    </div>
  </div>

  <script src="auth.js" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      try{
        const me = await auth.me();
        if(me){
          location.replace('ecn.html#autologin&ts=' + Date.now());
          return;
        }
      }catch(e){}

      const msg = document.getElementById('loginMsg');
      const up = document.getElementById('userpill');
      const btnLogin = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');

      btnLogin.addEventListener('click', async () => {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value;
        const d = (document.getElementById('loginDept')?.value || '').trim();

        msg.textContent = 'Đang đăng nhập...';
        msg.className = 'note';

        try{
          await auth.login(u,p,d || null);
          const me = await auth.me();
          if(!me) throw new Error('Token chưa sẵn sàng');
          up.textContent = me.name + ' • ' + me.dept + ' • ' + me.role;
          btnLogout.style.display = 'inline-block';
          location.replace('ecn.html#afterlogin&ts=' + Date.now());
        }catch(e){
          msg.textContent = 'Đăng nhập thất bại: ' + (e.message || 'Lỗi máy chủ');
          msg.className = 'note err';
        }
      });

      btnLogout.addEventListener('click', ()=>{
        auth.logout();
        location.reload();
      });
    });
  </script>
</body>
</html>
