<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ECN Manager — Login & System</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #eee}
    .brand{font-weight:700}
    .spacer{flex:1}
    .userpill{font-size:14px;opacity:.8}
    .wrap{display:flex;height:calc(100vh - 57px)}
    .left{width:420px;max-width:100%;border-right:1px solid #eee;padding:20px;overflow:auto}
    .right{flex:1;min-width:0}
    iframe{border:0;width:100%;height:100%}
    .hidden{display:none !important}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:white;cursor:pointer}
    .btn.primary{background:black;color:white;border-color:black}
    label{display:block;margin-top:10px;font-size:14px}
    input,select{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:8px;margin-top:6px}
    .note{font-size:12px;opacity:.7;margin-top:8px}
    .ok{color:green}
    .err{color:#b00020}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin-top:14px}
    .muted{opacity:.65}
  </style>
</head>
<body>
  <header>
    <div class="brand">ECN Manager</div>
    <div class="spacer"></div>
    <div id="userpill" class="userpill hidden"></div>
    <button id="btnLogout" class="btn hidden">Đăng xuất</button>
  </header>

  <div class="wrap">
    <div class="left" id="loginPane">
      <h2>Đăng nhập</h2>
      <div class="card">
        <label>Tài khoản</label>
        <input id="loginUser" placeholder="email hoặc ID"/>
        <label>Mật khẩu</label>
        <input id="loginPass" type="password" placeholder="•••••••"/>
        <label>Department</label>
        <select id="loginDept">
          <option value="">(Auto từ server)</option>
          <option>SMT</option><option>DIP</option><option>FE</option><option>PE</option><option>QC</option><option>COS</option>
        </select>
        <button id="btnLogin" class="btn primary" style="margin-top:12px">Vào hệ thống</button>
        <div id="loginMsg" class="note"></div>
      </div>
      <div class="card muted">
        <b>Lưu ý</b>
        <div class="note">Bản production: xác thực JWT từ server ASP.NET Core (IIS).</div>
      </div>
    </div>

    <div class="right">
      <iframe id="appFrame" class="hidden"></iframe>
    </div>
  </div>

<script>
function onAuthed(me){
  // Ẩn hoàn toàn panel login (tránh display bị CSS nào đó override)
  const lp = document.getElementById('loginPane');
  lp.classList.add('hidden');
  lp.style.display = 'none';
  lp.style.width = '0';
  lp.style.padding = '0';
  lp.style.border = '0';

  // Cập nhật thông tin user
  const up = document.getElementById('userpill');
  up.textContent = me.name + ' • ' + me.dept + ' • ' + me.role;
  up.classList.remove('hidden');
  document.getElementById('btnLogout').classList.remove('hidden');

  // Ép reload ECN để nhận token mới (cache-busting)
  const f = document.getElementById('appFrame');
  f.classList.remove('hidden');
  // nếu đã có src, đổi thành ecn.html?ts=<now> để chắc chắn nạp lại
  f.src = 'ecn.html?ts=' + Date.now();

  // optional: thêm listener để báo lỗi nếu iframe không tải được
  f.addEventListener('load', () => {
    // console.log('ECN loaded');
  });
}
</script>
</body>
</html>
