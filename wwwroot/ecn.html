
<!DOCTYPE html>
<html lang="en">
<head><script>
(async function(){
  const isTop = (window.top === window.self); // mở trực tiếp tab hay không

  async function me(){
    const t = localStorage.getItem('ecn_jwt');
    if(!t) throw new Error('no-token');
    const r = await fetch('api/me', { headers: { 'Authorization': 'Bearer ' + t }});
    if(!r.ok) throw new Error('unauthorized');
    const u = await r.json();
    window.ECN_CURRENT_USER = u;

    // Ví dụ: ép Department nếu không phải Admin
    try{
      const sel = document.getElementById('dDept') || document.getElementById('fDept');
      if(sel && u.role !== 'Admin'){ sel.value = u.dept; sel.disabled = true; }
    }catch(e){}
  }

  try{
    await me(); // OK -> cho hiển thị UI bình thường
  }catch(e){
    if (isTop){
      // Chỉ khi người dùng mở trực tiếp ecn.html mới chuyển về index
      window.location.replace('index.html?redirect=1');
    } else {
      // Nếu nhúng (không còn dùng), im lặng để tránh popup lặp
      document.body.innerHTML = '';
    }
  }
})();
</script>

<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ECN System — v8 (Monthly Sim Data)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --muted:#6b7280; --text:#0f172a;
    --primary:#0ea5e9; --primary-600:#0284c7; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
    --border:#e5e7eb; --shadow:0 8px 24px rgba(2,6,23,.08);
    --task1:#0ea5e9; --task2:#22c55e; --taskbarH:28px;
    --rankA:#16a34a; --rankB:#2563eb; --rankC:#f59e0b; --rankD:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#fbfdff,var(--bg) 30%)}
  .app{display:grid;grid-template-columns:184px 1fr;min-height:100dvh}
  aside{background:#0b1220;color:#cbd5e1;padding:14px 10px;position:sticky;top:0;height:100dvh}
  .brand{display:flex;align-items:center;gap:8px;margin-bottom:10px}
  .brand .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 180deg at 50% 50%, #22c55e, #0ea5e9, #7c3aed, #22c55e);display:grid;place-items:center;color:#fff;font-weight:900;font-size:14px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .brand .logo::after{content:"AI";filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
  .brand h1{font-size:14px;margin:0;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  nav{margin-top:6px}
  .nav-section{margin-top:10px;font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:#94a3b8;padding:0 4px 4px}
  .nav-section.support{margin-top:37.8px; position:relative;}
  .nav-section.support::before{content:""; position:absolute; top:-22px; left:6px; right:6px; height:1px; background:linear-gradient(90deg,transparent,#1f2937,transparent); box-shadow:0 1px 0 rgba(255,255,255,.05)}
  .nav-item{padding:7px 8px;border-radius:10px;cursor:pointer;color:#cbd5e1;font-size:13px}
  .nav-item:hover{background:#0f172a}.nav-item.active{background:#111827;color:#fff;font-weight:600}
  .ai-launch{margin:10px 6px 8px;padding:10px;border-radius:12px;background:linear-gradient(135deg,#0ea5e9,#7c3aed); display:flex;align-items:center;gap:10px;cursor:pointer;box-shadow:0 10px 20px rgba(2,6,23,.35)}
  .ai-launch svg{width:18px;height:18px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
  .ai-launch span{font-weight:800;color:#fff}
  .user{position:absolute;bottom:10px;left:10px;right:10px;padding:8px;border-radius:12px;background:#0f172a;color:#e5e7eb;font-size:12px}
  main{padding:10px 12px 16px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{padding:5px 9px;border-radius:10px;background:#eef2ff;color:#3730a3;font-weight:600;display:inline-flex;gap:6px}
  .badge{padding:3px 9px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff}
  .spacer{flex:1}
  .search{min-width:220px;flex:1;max-width:420px;position:relative}
  .search input{width:100%;padding:8px 38px 8px 34px;border-radius:10px;border:1px solid var(--border);background:#fff;outline:none;font-size:13px}
  .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.7}
  .btn{border:1px solid var(--primary);color:#fff;background:linear-gradient(180deg,var(--primary),var(--primary-600));padding:7px 10px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:var(--shadow);font-size:13px}
  .btn.secondary{border-color:var(--border);background:#fff;color:#0f172a}
  .lang{min-width:120px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow)}
  .card .head{padding:8px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .card .body{padding:8px 10px 10px}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .filter{border:1px solid var(--border);background:#fff;border-radius:10px;padding:5px 7px;display:flex;align-items:center;gap:6px;font-size:13px}
  select,input{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 8px;font-size:13px;outline:none}
  .hidden{display:none!important}
  /* Tables */
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{text-align:left;font-size:12px;color:#fff;padding:6px 8px}
  thead tr.taskbar{background:linear-gradient(90deg,var(--task1),var(--task2));height:var(--taskbarH)}
  tbody tr{background:#fff;border:1px solid var(--border)}
  tbody tr td{padding:6px 8px;font-size:12.5px;vertical-align:middle}
  tbody tr{border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  /* Drawer (view) with section tiles */
  .drawer{position:fixed;top:0;right:-520px;width:520px;height:100dvh;background:#fff;border-left:1px solid var(--border);box-shadow:-12px 0 32px rgba(2,6,23,.12);transition:right .28s ease;z-index:60;display:flex;flex-direction:column}
  .drawer.open{right:0}
  .drawer .dh{padding:10px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:1}
  .drawer .dc{padding:10px;overflow:auto}
  .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);margin-bottom:8px}
  .tab{padding:6px 10px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:#f8fafc;cursor:pointer}
  .tab.active{background:#fff;font-weight:700}
  .kv-tile{background:linear-gradient(180deg,#fbfbfe,#f6f7fb);border:1px solid #e9ecf3;border-radius:12px;padding:8px 10px;margin:6px 0;box-shadow:0 6px 16px rgba(2,6,23,.06)}
  .kv-tile .k{color:#6b7280;font-size:11px;text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .badge-mini{padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:11px}
  /* Heatmap & charts slim */
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:stretch}
  canvas{height:200px !important}
  .heatmap{display:grid;grid-template-columns:80px repeat(12,1fr);border:1px solid var(--border);background:#fff;border-radius:10px;overflow:hidden}
  .heatmap div{padding:6px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);text-align:center;font-size:11px}
  .heatmap .hhead{background:#0f172a;color:#fff;font-weight:700}
  /* Status icons & Rank */
  .s-dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle}
  .s-pending{background:var(--warn)} .s-progress{background:var(--primary)} .s-done{background:var(--ok)}
  .rank{display:inline-flex;align-items:center;gap:6px}
  .rank-badge{min-width:22px;height:22px;border-radius:6px;display:grid;place-items:center;color:#fff;font-weight:900;font-size:12px;box-shadow:var(--shadow)}
  .rank-A{background:var(--rankA)} .rank-B{background:var(--rankB)} .rank-C{background:var(--rankC)} .rank-D{background:var(--rankD)}
  /* Pagination top */
  .topline{display:flex;align-items:center;gap:8px}
  .pagination{margin-left:auto;display:flex;gap:8px;align-items:center}
  .page-mini{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}
  /* KPI tiny cards */
  .kpis{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px}
  .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow)}
  .kpi .k{color:var(--muted);font-size:12px} .kpi .v{font-size:20px;font-weight:900;margin-top:2px}
  /* Chatroom */
  .chat-bubble{max-width:80%;padding:8px 12px;border-radius:16px;margin:4px 0;box-shadow:0 4px 10px rgba(2,6,23,.08)}
  .me{background:#dcfce7;margin-left:auto} .other{background:#e5f3ff}
  .chat-sender{font-size:11px;color:#64748b;margin-top:-2px}
  /* Language switcher placement */
  .lang-wrap{display:flex;align-items:center;gap:6px}
  @media (max-width: 980px){
    .app{grid-template-columns:1fr}
    .drawer{width:100%}
    .row-2{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="app">
  <aside>
    <div class="brand">
      <div class="logo"></div>
      <h1>ECN System</h1>
    </div>
    <div class="ai-launch" id="openAI">
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 3l2.5 4.5L20 9l-3.5 3 1 5-5-2.5L7.5 17l1-5L5 9l5.5-1.5L12 3z" stroke="#fff" stroke-width="1.5" stroke-linejoin="round"/></svg>
      <span>ECN AI Advisor</span>
    </div>
    <nav id="nav">
      <div class="nav-section">Main</div>
      <div class="nav-item active" data-nav="dashboard">Dashboard</div>
      <div class="nav-item" data-nav="ecnMaster">ECN Master</div>
      <div class="nav-item" data-nav="department">Department</div>
      <div class="nav-item" data-nav="admin">Admin</div>
      <div class="nav-section support">Support Tools</div>
      <div class="nav-item" data-nav="chatroom">Chatroom</div>
      <div class="nav-item" data-nav="convertBOM">Convert BOM</div>
      <div class="nav-item" data-nav="wiVerify">WI Verify</div>
    </nav>
    <div class="user"><div style="font-weight:700">App Mode:</div><small>Demo UI — offline</small></div>
  </aside>

  <main>
    <div class="toolbar">
      <div class="chip">Ready</div><div class="badge">UI v8</div>
      <div class="spacer"></div>
      <div class="search">
        <svg viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z" stroke="#64748b" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="q" placeholder="Search ECN (no., content, dept, owner)..." />
      </div>
      <div class="lang-wrap">
        <span class="badge">Language</span>
        <select id="langTop" class="lang">
<option value="en">English</option><option value="vi">Tiếng Việt</option><option value="ja">日本語</option>
          <option value="en">English</option><option value="vi">Tiếng Việt</option><option value="zh">中文</option>
          <option value="ja">日本語</option><option value="ko">한국어</option><option value="es">Español</option>
          <option value="fr">Français</option><option value="de">Deutsch</option>
        </select>
      </div>
      <button class="btn secondary" id="btnExportAll">Export ECN CSV</button>
      <button class="btn" id="btnNew">+ New ECN</button>
      <input type="file" id="newFile" accept=".csv,.tsv,.txt" class="hidden" />
    </div>

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="grid">
      <section class="card">
        <div class="head"><strong>KPIs</strong></div>
        <div class="body">
          <div class="kpis">
            <div class="kpi"><div class="k">Pending</div><div class="v" id="kPending">0</div></div>
            <div class="kpi"><div class="k">In Progress</div><div class="v" id="kProgress">0</div></div>
            <div class="kpi"><div class="k">Effective</div><div class="v" id="kEffective">0</div></div>
            <div class="kpi"><div class="k">Completed</div><div class="v" id="kArchived">0</div></div>
          </div>
        </div>
      </section>
      <section class="card">
        <div class="head"><strong>Trends</strong></div>
        <div class="body row-2">
          <canvas id="yearlyChart"></canvas>
          <canvas id="monthlyChart"></canvas>
        </div>
      </section>
      <section class="card">
        <div class="head"><strong>Department × Month Heatmap</strong></div>
        <div class="body"><div class="heatmap" id="heatmap"></div></div>
      </section>
    </section>

    <!-- ECN MASTER -->
    <section id="page-ecnMaster" class="grid hidden">
      <section class="card">
        <div class="head topline">
          <strong>ECN Master</strong>
          <div class="filters">
            <div class="filter"><span>Status</span>
              <select id="fStatusSel"><option value="">All</option><option>Pending</option><option>In progress</option><option>Completed</option></select>
            </div>
            <div class="filter"><label>Department</label>
              <select id="fDept">
                <option value="">All</option><option>SMT</option><option>DIP</option><option>FA</option><option>FE</option>
                <option>PE</option><option>QC</option><option>PMS</option><option>PSCD</option><option>COS</option>
              </select>
            </div>
            <div class="filter"><label>Effective</label><input id="fDateFrom" type="date" />–<input id="fDateTo" type="date" /></div>
          </div>
          <!-- Legend on the right -->
          <div class="pagination">
            <div class="badge"><span class="s-dot s-pending"></span>Pending</div>
            <div class="badge"><span class="s-dot s-progress"></span>In progress</div>
            <div class="badge"><span class="s-dot s-done"></span>Completed</div>
            <button class="btn secondary" id="prevPage">Back</button>
            <button class="btn" id="nextPage">Go</button>
          </div>
        </div>
        <div class="body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr class="taskbar">
                  <th>Rank</th><th>ECN No.</th><th>Sub ECN</th><th>Model</th><th>Title</th><th>Before</th><th>After</th><th>Effective</th><th>Valid BOM</th><th>Status</th><th>View</th>
                </tr>
              </thead>
              <tbody id="ecnRows"></tbody>
            </table>
            <div class="page-mini" id="miniInfo">Page 1/1 — 0 items</div>
          </div>
        </div>
      </section>

      <!-- Staging panel -->
      <section class="card hidden" id="stagingPanel">
        <div class="head"><strong>Staging — Review imported ECN</strong><div class="spacer"></div><button class="btn" id="confirmImport">Confirm & Push</button></div>
        <div class="body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr class="taskbar">
                  <th>ECN No.</th><th>Sub ECN</th><th>Model</th><th>Title</th><th>Before</th><th>After</th><th>Effective</th><th>Valid BOM</th><th>Status</th>
                </tr>
              </thead>
              <tbody id="stagingRows"></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>

    <!-- DEPARTMENT -->
    <section id="page-department" class="grid hidden">
      <section class="card">
        <div class="head"><strong>Department</strong>
          <div class="filters">
            <div class="filter"><label>Department</label>
              <select id="dDept">
                <option>SMT</option><option>DIP</option><option>FA</option><option>FE</option><option>PE</option><option>QC</option><option>PMS</option><option>PSCD</option><option>COS</option>
              </select>
            </div>
            <div class="filter"><label>Owner</label><input id="dOwner" placeholder="Owner name"/></div>
            <div class="filter"><label>Priority</label>
              <select id="dPrio"><option>All</option><option>High</option><option>Medium</option><option>Low</option></select>
            </div>
          </div>
        </div>
        <div class="body">
          <div id="deptFields" class="filters" style="margin-bottom:8px"></div>
          <div style="overflow:auto">
            <table>
              <thead id="deptHead"></thead>
              <tbody id="deptRows"></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>

    <!-- ADMIN -->
    <section id="page-admin" class="grid hidden">
      <section class="card">
        <div class="head"><strong>Feature Flags & Preferences</strong></div>
        <div class="body">
          <div class="filters">
            <label class="filter"><input type="checkbox" id="ff-chatroom" checked> Chatroom</label>
            <label class="filter"><input type="checkbox" id="ff-convert" checked> Convert BOM</label>
            <label class="filter"><input type="checkbox" id="ff-wi" checked> WI Verify</label>
            <label class="filter"><input type="checkbox" id="ff-lic"> 1-device License</label>
            <label class="filter">Language
              <select id="lang">
<option value="en">English</option><option value="vi">Tiếng Việt</option><option value="ja">日本語</option>
                <option value="en">English</option><option value="vi">Tiếng Việt</option><option value="zh">中文</option>
                <option value="ja">日本語</option><option value="ko">한국어</option><option value="es">Español</option>
                <option value="fr">Français</option><option value="de">Deutsch</option>
              </select>
            </label>
          </div>
        </div>
      </section>
      <section class="card">
        <div class="head"><strong>User Management</strong></div>
        <div class="body">
          <div class="filters">
            <input id="uName" placeholder="Họ và Tên" /><input id="uEmail" placeholder="Email" /><input id="uID" placeholder="ID" />
            <select id="uDept"><option>SMT</option><option>DIP</option><option>FA</option><option>FE</option><option>PE</option><option>QC</option><option>PMS</option><option>PSCD</option><option>COS</option></select>
            <select id="uRole"><option>Viewer</option><option>Editor</option><option>Approver</option><option>Admin</option></select>
            <button class="btn" id="uAdd">Add</button>
          </div>
          <div style="overflow:auto;margin-top:8px">
            <table>
              <thead><tr class="taskbar"><th>Họ và Tên</th><th>Email</th><th>ID</th><th>Department</th><th>Role</th><th>Delete</th></tr></thead>
              <tbody id="uRows"></tbody>
            </table>
          </div>
          <!-- AI Advisor prompt config -->
          <div class="head" style="border:none;padding-left:0;margin-top:8px"><strong>ECN AI Advisor — Prompt</strong></div>
          <textarea id="aiPrompt" placeholder="System prompt for ECN Advisor (guidelines, tone, rules)..." style="min-height:80px"></textarea>
          <button class="btn" id="savePrompt" style="margin-top:6px">Save Prompt</button>
        </div>
      </section>
    </section>

    <!-- CHATROOM -->
    <section id="page-chatroom" class="grid hidden">
      <section class="card">
        <div class="head"><strong>Team Chat</strong></div>
        <div class="body">
          <div id="chatLog" style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;min-height:180px;max-height:280px;overflow:auto"></div>
          <div class="chat-sender" id="chatHint">Demo: team messages appear here…</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <textarea id="chatTxt" placeholder="Type a message..." style="flex:1;min-height:42px"></textarea>
            <button class="btn" id="chatSend">Send</button>
          </div>
        </div>
      </section>
    </section>

    <!-- CONVERT BOM -->
    <section id="page-convertBOM" class="grid hidden">
      <section class="card">
        <div class="head"><strong>Convert BOM (CSV)</strong></div>
        <div class="body">
          <div class="filters">
            <input type="file" id="bomFile" accept=".csv,.tsv,.txt" /><button class="btn secondary" id="bomParse">Parse File</button>
            <div class="spacer"></div><button class="btn" id="bomDownload">Download Normalized CSV</button>
          </div>
          <div style="margin-top:8px" class="label">Or paste CSV below:</div>
          <textarea id="bomPaste" placeholder="PartNo, Description, Qty, RefDes"></textarea>
          <div id="bomOutWrap" style="margin-top:10px;overflow:auto">
            <table id="bomOut" style="min-width:720px">
              <thead><tr class="taskbar"><th>PartNo</th><th>Description</th><th>Qty</th><th>RefDes</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>

    <!-- WI VERIFY -->
    <section id="page-wiVerify" class="grid hidden">
      <section class="card">
        <div class="head"><strong>WI Verify vs ECN Master</strong></div>
        <div class="body">
          <div class="filters">
            <div class="filter"><span class="label">ECN Master (CSV)</span><input type="file" id="wiEcn" accept=".csv,.tsv,.txt" /></div>
            <div class="filter"><span class="label">WI Pages (CSV/TSV)</span><input type="file" id="wiPages" accept=".csv,.tsv,.txt" /></div>
            <button class="btn secondary" id="wiRun">Compare</button><div class="spacer"></div><div class="badge">Output: OK / NG</div>
          </div>
          <div style="overflow:auto;margin-top:10px">
            <table id="wiTable" style="min-width:900px">
              <thead><tr class="taskbar"><th>Item</th><th>ECN Part</th><th>ECN After</th><th>WI Value</th><th>Status</th><th>Note</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>
  </main>
</div>

<!-- Drawer for ECN detail -->
<div class="drawer" id="drawer">
  <div class="dh"><strong>ECN Detail</strong><div class="spacer"></div><button class="btn secondary" id="closeDrawer">Close</button></div>
  <div class="dc">
    <div class="tabs">
      <div class="tab active" data-t="info">Info</div>
      <div class="tab" data-t="history">History</div>
      <div class="tab" data-t="feedback">Feedback</div>
    </div>
    <div id="panel-info">
      <div class="kv-tile"><div class="k">Ngày issue</div><div id="v-issue"></div></div>
      <div class="kv-tile"><div class="k">Tiêu đề</div><div id="v-title" style="font-weight:700"></div></div>
      <div class="kv-tile"><div class="k">Reason</div><div id="v-reason" style="white-space:pre-wrap"></div></div>
      <div class="kv-tile"><div class="k">Hiệu lực</div><div id="v-effect"></div></div>
      <div class="grid2">
        <div class="kv-tile"><div class="k">Trạng thái</div><div id="v-status"></div></div>
        <div class="kv-tile">
          <div class="k">Per‑Department Effective</div>
          <div id="v-perdept" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>
      </div>
      <div class="kv-tile"><div class="k">Latest change</div><div id="v-last"></div></div>
    </div>
    <div id="panel-history" class="hidden"><div id="historyList"></div></div>
    <div id="panel-feedback" class="hidden">
      <div class="kv-tile">
        <div class="k">Feedback</div>
        <div><textarea id="fbMsg" placeholder="Mô tả vấn đề, ảnh hưởng, đề xuất..." style="width:100%;min-height:120px"></textarea></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label>Priority</label>
        <select id="fbPrio"><option>High</option><option>Medium</option><option>Low</option></select>
        <button class="btn" id="fbSend">Send feedback</button>
      </div>
      <div id="fbNote" class="muted" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </div>
</div>

<!-- AI panel floating (opened from sidebar button) -->
<div class="ai-panel" id="aiPanel" style="right:18px;bottom:78px;width:340px;display:none">
  <div class="ai-head">ECN AI Advisor</div>
  <div class="ai-body" id="aiBody"><em>Ask about ECN status, effective dates, or history...</em></div>
  <div class="ai-input"><input id="aiAsk" placeholder="e.g., status ECN-1012" /><button id="aiSend">Send</button></div>
</div>

<script>
// Value label plugin (bar-only) + color helpers — minimal and safe
const LineValueLabelPlugin={id:'lineValueLabel',afterDatasetsDraw(chart){if(chart.config.type!=='line')return;const{ctx,data}=chart;const meta=chart.getDatasetMeta(0);ctx.save();ctx.fillStyle='#111';ctx.font='bold 11px Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';meta.data.forEach((pt,i)=>{const val=data.datasets[0].data[i];if(val==null)return;const p=pt.tooltipPosition();ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(String(val),p.x,p.y-6);});ctx.restore();}};Chart.register(LineValueLabelPlugin);
(function(){
  if(!window.Chart || !Chart.register) return;
  const ValueLabelPlugin = {
    id: 'barValueLabel',
    afterDatasetsDraw(chart, args, opts){
      if(chart.config.type!=='bar') return;
      const {ctx, data} = chart;
      const meta = chart.getDatasetMeta(0);
      ctx.save();
      ctx.fillStyle = '#111';
      ctx.font = 'bold 12px Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      meta.data.forEach((el, i)=>{
        const val = data.datasets[0].data[i];
        if(val==null) return;
        const p = el.tooltipPosition();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(String(val), p.x, p.y - 4);
      });
      ctx.restore();
    }
  };
  Chart.register(ValueLabelPlugin);
})();
// Map value to HSL: 140 (green) → 28 (deep orange), avoid red
function colorScale(v, vmin, vmax){
  var t = (v - vmin) / Math.max(1, (vmax - vmin));
  if (t < 0) t = 0; if (t > 1) t = 1;
  var hue = 140 - (140-28)*t;    // green to deep orange
  var sat = 85;                   // vivid
  var light = 50 - 5*t;           // slightly darker on high
  return 'hsl(' + hue + ' ' + sat + '% ' + light + '%)';
}

// ----- Router -----
const nav = document.getElementById('nav');
function showTab(id){
  document.querySelectorAll('main > section').forEach(sec=>sec.classList.add('hidden'));
  const target = document.getElementById('page-'+id);
  if(target) target.classList.remove('hidden');
  localStorage.setItem('ecn_last_tab', id);
}
nav.addEventListener('click', (e)=>{
  const item = e.target.closest('.nav-item'); if(!item) return;
  nav.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  item.classList.add('active'); showTab(item.dataset.nav);
});
(function restoreTab(){
  const t = localStorage.getItem('ecn_last_tab') || 'dashboard';
  const el = nav.querySelector(`[data-nav="${t}"]`); if(el){ el.classList.add('active'); showTab(t); }
})();
// Language switch sync
document.getElementById('langTop').addEventListener('change', (e)=> localStorage.setItem('ecn_lang', e.target.value));
(function(){ const L = localStorage.getItem('ecn_lang'); if(L) document.getElementById('langTop').value=L; })();

// ----- Demo data (heavy, month-distributed) -----
const statuses = ["Pending","In progress","Completed"];
const departments = ["SMT","DIP","FA","FE","PE","QC","PMS","PSCD","COS"];
const models = ["MDL-310","MDL-220","MDL-450","MDL-500","MDL-700","MDL-900"];
const titles = ["Update PCB layout","Change resistor type","Modify housing","Firmware update","Relocate label","Harness length adj","Spec tighten","Safety marking adj","Sealant change","Connector pin swap"];
const owners = ["Minh Nguyen","Lan Tran","Quang Le","Anh Ho","Bao Pham","Duong Vo","COS Bot","QC Team","PE Lead","FE Owner"];
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randCode(len){ const c="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; let s=""; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
function partCode(){ return randCode(10+Math.floor(Math.random()*6)); }
function pad(n){ return n<10?("0"+n):(""+n); }
function randomInt(a,b){ return a+Math.floor(Math.random()*(b-a+1)); }
function randReason(){
  const pool=[
    "Quality drift found on line\n- Root cause: solder voids\n- Action: change paste type",
    "Supplier EOL notice; migrate to alt part",
    "Regulatory label relocation per IEC update",
    "Improve torque margin for FA station",
    "Optimize oven profile for DIP",
    "Address OQC NCR-455: add spacer"
  ];
  return rand(pool);
}
// Monthly plan with light seasonality
const monthPlan = [28,30,26,32,34,36,38,42,40,35,30,28]; // Jan..Dec
// Slight randomness per month
const ECN=[]; let idx=1;
for(let m=0;m<12;m++){
  const count = monthPlan[m] + randomInt(-4,4);
  for(let k=0;k<count; k++){
    const day = randomInt(1, Math.max(25, randomInt(24,28)));
    const issueDay = Math.max(1, day - randomInt(1,7));
    const dt = `2025-${pad(m+1)}-${pad(day)}`;
    const issue = `2025-${pad(m+1)}-${pad(issueDay)}`;
    const priority = rand(["High","Medium","Low","Low","Medium"]);
    const status = rand(statuses);
    const rec = {
      idx: idx++,
      ecnNo: "ECN-"+(1000+idx),
      sub: "SUB-"+(1000+idx),
      model: rand(models),
      title: rand(titles),
      reason: randReason(),
      before: partCode(),
      after: partCode(),
      issue: issue,
      effective: dt,
      valid: dt,
      status: status,
      dept: rand(departments),
      owner: rand(owners),
      priority: priority,
      history: [
        {ts:`2025-${pad(Math.max(1,m))}-${pad(randomInt(1,28))}`, by: rand(owners), note:"Initial draft created"},
        {ts:`2025-${pad(m+1)}-${pad(Math.max(1, day-2))}`, by: rand(owners), note:"WI reference updated"}
      ]
    };
    // Rank A-D
    let score = 0;
    if(priority==="High") score+=2; else if(priority==="Medium") score+=1;
    if(status==="Pending") score+=2; else if(status==="In progress") score+=1;
    const days = (Date.now() - new Date(issue).getTime())/86400000;
    if(days < 20) score+=2; else if(days<60) score+=1;
    rec.rankL = score>=5 ? "A" : score>=3 ? "B" : score>=2 ? "C" : "D";
    ECN.push(rec);
  }
}

// ----- Dashboard KPIs & charts -----
function dashKPIs(){
  const k={Pending:0,"In progress":0,Completed:0};
  ECN.forEach(r=>k[r.status]++);
  document.getElementById("kPending").textContent=k.Pending;
  document.getElementById("kProgress").textContent=k["In progress"];
  document.getElementById("kEffective").textContent=(ECN.filter(r=>r.valid===r.effective).length)||0;
  document.getElementById("kArchived").textContent = ECN.filter(r=>r.status==="Completed").length;
}
function dashCharts(){
  // Yearly bars (per month totals)
  const monthlyTotals = Array(12).fill(0);
  ECN.forEach(r=> monthlyTotals[new Date(r.effective).getMonth()]++);
  const __minV = Math.min(...monthlyTotals), __maxV = Math.max(...monthlyTotals);
const __barColors = monthlyTotals.map(v=> colorScale(v, __minV, __maxV));
new Chart(document.getElementById('yearlyChart'),{
    type:'bar',
    data:{labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      datasets:[{label:'ECN/Month',data:monthlyTotals, backgroundColor: __barColors, borderColor: __barColors, borderWidth:1}]}
  });
  // Current month daily line
  const cm=new Date().getMonth();
  const map={};
  ECN.filter(r=>new Date(r.effective).getMonth()===cm).forEach(r=>{
    const d=new Date(r.effective).getDate();
    map[d]=(map[d]||0)+1;
  });
  const days=Object.keys(map).sort((a,b)=>a-b);
  const vals=days.map(d=>map[d]);
  new Chart(document.getElementById('monthlyChart'),{type:'line',data:{labels:days,datasets:[{label:'ECN/day',data:vals,fill:false}]}});
  // Heatmap
  const grid=document.getElementById('heatmap'); grid.innerHTML="";
  const head=["Dept","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  head.forEach(h=>{ const div=document.createElement('div'); div.textContent=h; div.className="hhead"; grid.appendChild(div); });
  const months=[0,1,2,3,4,5,6,7,8,9,10,11];
  departments.forEach(dep=>{
    const t=document.createElement('div'); t.textContent=dep; t.style.fontWeight="700"; grid.appendChild(t);
    months.forEach(i=>{
      const n=ECN.filter(r=>r.dept===dep && new Date(r.effective).getMonth()===i).length;
      const cell=document.createElement('div'); cell.textContent=n?String(n):"";
      const alpha=Math.min(1,n/Math.max(6, monthPlan[i] / departments.length));
      cell.style.background=`rgba(14,165,233,${0.05+alpha*0.28})`;
      grid.appendChild(cell);
    });
  });
}

// ----- Global search affects ECN Master -----
const state = { q:"", statusSel:"", dept:"", from:"", to:"", page:1, pageSize:10 };
document.getElementById('q').addEventListener('input', e=>{ state.q=e.target.value.trim(); state.page=1; renderECN(); });

// ----- Status & Rank renderers -----
function statusIconOnly(s){
  if(s==="Completed") return '<span class="s-dot s-done" title="Completed"></span>';
  if(s==="In progress") return '<span class="s-dot s-progress" title="In progress"></span>';
  return '<span class="s-dot s-pending" title="Pending"></span>';
}
function rankBadge(letter){
  return `<span class="rank"><span class="rank-badge rank-${letter}">${letter}</span></span>`;
}
function matchECN(r){
  if(state.q){
    const q=state.q.toLowerCase();
    const blob=(r.ecnNo+" "+r.sub+" "+r.model+" "+r.title+" "+r.reason+" "+r.before+" "+r.after+" "+r.dept+" "+r.owner).toLowerCase();
    if(!blob.includes(q)) return false;
  }
  if(state.dept && r.dept!==state.dept) return false;
  if(state.statusSel && r.status!==state.statusSel) return false;
  if(state.from && r.effective<state.from) return false;
  if(state.to && r.effective>state.to) return false;
  return true;
}
function renderECN(){
  const tb=document.getElementById('ecnRows'); tb.innerHTML="";
  const rowsAll=ECN.filter(matchECN);
  const total=rowsAll.length; const pages=Math.max(1,Math.ceil(total/state.pageSize));
  if(state.page>pages) state.page=pages;
  const start=(state.page-1)*state.pageSize; const pageRows=[...rowsAll].sort((a,b)=> (a.rankL||"Z").localeCompare(b.rankL||"Z") ).slice(start, start+state.pageSize);
  pageRows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${rankBadge(r.rankL)}</td><td><strong>${r.ecnNo}</strong></td><td>${r.sub}</td><td>${r.model}</td>
      <td>${r.title}</td><td><code>${r.before}</code></td><td><code>${r.after}</code></td>
      <td>${r.effective}</td><td>${r.valid}</td><td style="text-align:center">${statusIconOnly(r.status)}</td>
      <td><button class="btn secondary btn-view" data-id="${r.ecnNo}">View</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('.btn-view').forEach(b=> b.addEventListener('click',(ev)=>{
    const id=ev.currentTarget.getAttribute('data-id'); const r=ECN.find(x=>x.ecnNo===id); if(r) openDetail(r);
  }));
  document.getElementById('miniInfo').textContent=`Page ${state.page}/${pages} — ${total} items`;
  document.getElementById('prevPage').disabled=state.page<=1;
  document.getElementById('nextPage').disabled=state.page>=pages;
}
document.getElementById('prevPage').addEventListener('click',()=>{state.page=Math.max(1,state.page-1);renderECN();});
document.getElementById('nextPage').addEventListener('click',()=>{state.page=state.page+1;renderECN();});
document.getElementById('fDept').addEventListener('change',e=>{state.dept=e.target.value;state.page=1;renderECN();});
document.getElementById('fStatusSel').addEventListener('change',e=>{state.statusSel=e.target.value;state.page=1;renderECN();});
document.getElementById('fDateFrom').addEventListener('change',e=>{state.from=e.target.value;state.page=1;renderECN();});
document.getElementById('fDateTo').addEventListener('change',e=>{state.to=e.target.value;state.page=1;renderECN();});

// ----- Drawer View (styled) -----
const drawer=document.getElementById('drawer');
function openDetail(r){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('.tab[data-t="info"]').classList.add('active');
  document.getElementById('panel-info').classList.remove('hidden');
  document.getElementById('panel-history').classList.add('hidden');
  document.getElementById('panel-feedback').classList.add('hidden');
  document.getElementById('v-issue').textContent=r.issue;
  document.getElementById('v-title').textContent=`${r.title} (${r.model}) — ${r.ecnNo}`;
  document.getElementById('v-reason').textContent=r.reason;
  document.getElementById('v-effect').textContent=`Effective: ${r.effective} — Valid BOM: ${r.valid}`;
  document.getElementById('v-status').innerHTML = statusIconOnly(r.status);
  const wrap=document.getElementById('v-perdept'); wrap.innerHTML="";
  ["SMT","DIP","FA","FE","PE","QC","COS"].forEach((d,i)=>{
    const dt=new Date(r.effective); dt.setDate(dt.getDate()+i*2);
    const tag=document.createElement('div'); tag.className='badge-mini'; tag.textContent=`${d}: ${dt.toISOString().slice(0,10)}`; wrap.appendChild(tag);
  });
  const last=r.history[r.history.length-1]; document.getElementById('v-last').textContent=`${last.ts} by ${last.by} — ${last.note}`;
  const hist=document.getElementById('historyList'); hist.innerHTML="";
  r.history.forEach(h=>{ const row=document.createElement('div'); row.className='kv-tile'; row.innerHTML=`<div class="k">${h.ts} • ${h.by}</div><div>${h.note}</div>`; hist.appendChild(row); });
  document.getElementById('fbPrio').value="Medium"; document.getElementById('fbMsg').value=""; document.getElementById('fbNote').textContent="";
  drawer.classList.add('open');
}
document.getElementById('closeDrawer').addEventListener('click',()=>drawer.classList.remove('open'));
document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  document.getElementById('panel-info').classList.toggle('hidden', t.dataset.t!=='info');
  document.getElementById('panel-history').classList.toggle('hidden', t.dataset.t!=='history');
  document.getElementById('panel-feedback').classList.toggle('hidden', t.dataset.t!=='feedback');
}));
document.getElementById('fbSend').addEventListener('click',()=>{
  const p=document.getElementById('fbPrio').value; const msg=document.getElementById('fbMsg').value.trim();
  if(!msg){ alert("Nhập nội dung feedback"); return; }
  document.getElementById('fbNote').textContent=`Feedback sent to ECN members • Priority: ${p}`;
});

// ----- Department: base columns + per-dept extra cols after Valid BOM -----
const deptExtras = {
  FE: ["Revise WI","Delivery WI"],
  PE: ["ROM master"],
  SMT:["ROM master","Apply date"],
  FA: ["Apply date"],
  OQC:["Apply date"]
};
function renderDeptHead(dep){
  const base = ["Rank","ECN No.","Sub ECN","Model","Title","Before","After","Effective","Valid BOM","Status","View"];
  const extras = deptExtras[dep] || [];
  const ths = base.concat(extras).map(h=>`<th>${h}</th>`).join("");
  document.getElementById('deptHead').innerHTML = `<tr class="taskbar">${ths}</tr>`;
}
function renderDeptFields(dep){
  const wrap=document.getElementById('deptFields'); wrap.innerHTML="";
  const extras = deptExtras[dep] || [];
  if(extras.length){
    const hint=document.createElement('div'); hint.className="badge"; hint.textContent = `+ Fields: ${extras.join(", ")}`;
    wrap.appendChild(hint);
  }
}
function renderDeptTable(){
  const dep=document.getElementById('dDept').value; const owner=document.getElementById('dOwner').value.trim().toLowerCase(); const pr=document.getElementById('dPrio').value;
  renderDeptHead(dep); renderDeptFields(dep);
  const tb=document.getElementById('deptRows'); tb.innerHTML="";
  ECN.filter(r=>r.dept===dep).filter(r=>owner?String(r.owner).toLowerCase().includes(owner):true).filter(r=>pr==="All"?true:r.priority===pr).forEach(r=>{
    const cells = [
      rankBadge(r.rankL), `<strong>${r.ecnNo}</strong>`, r.sub, r.model, r.title,
      `<code>${r.before}</code>`, `<code>${r.after}</code>`, r.effective, r.valid, statusIconOnly(r.status),
      `<button class="btn secondary">View</button>`
    ];
    const extras = (deptExtras[dep]||[]).map(x=> (x.includes("Apply") ? new Date(r.effective).toISOString().slice(0,10) : (x.includes("ROM") ? ("ROM-"+r.model) : "WI-"+r.model)) );
    const tr=document.createElement('tr'); tr.innerHTML = cells.concat(extras).map(td=>`<td>${td}</td>`).join("");
    tr.querySelector('button').addEventListener('click',()=>openDetail(r));
    tb.appendChild(tr);
  });
}
document.getElementById('dDept').addEventListener('change',()=>{renderDeptTable();});
document.getElementById('dOwner').addEventListener('input',renderDeptTable);
document.getElementById('dPrio').addEventListener('change',renderDeptTable);

// ----- Admin flags + users + AI prompt -----
const FF={chatroom:document.getElementById('ff-chatroom'),convert:document.getElementById('ff-convert'),wi:document.getElementById('ff-wi'),lic:document.getElementById('ff-lic'),lang:document.getElementById('lang')};
(function restoreFF(){try{const s=JSON.parse(localStorage.getItem('ecn_flags')||'{}');FF.chatroom.checked=s.chatroom??true;FF.convert.checked=s.convert??true;FF.wi.checked=s.wi??true;FF.lic.checked=!!s.lic;if(s.lang)FF.lang.value=s.lang;applyFlags();}catch(e){}})();
function saveFF(){const obj={chatroom:FF.chatroom.checked,convert:FF.convert.checked,wi:FF.wi.checked,lic:FF.lic.checked,lang:FF.lang.value};localStorage.setItem('ecn_flags',JSON.stringify(obj));applyFlags();}
function applyFlags(){document.querySelector('[data-nav="chatroom"]').classList.toggle('hidden',!FF.chatroom.checked);document.querySelector('[data-nav="convertBOM"]').classList.toggle('hidden',!FF.convert.checked);document.querySelector('[data-nav="wiVerify"]').classList.toggle('hidden',!FF.wi.checked);}
FF.chatroom.addEventListener('change',saveFF);FF.convert.addEventListener('change',saveFF);FF.wi.addEventListener('change',saveFF);FF.lic.addEventListener('change',saveFF);FF.lang.addEventListener('change',saveFF);

let USERS=JSON.parse(localStorage.getItem('ecn_users')||'[]');
if(!USERS.length){
  USERS = [
    {name:"Minh Nguyen", email:"minh.nguyen@company.com", id:"U001", dept:"SMT", role:"Editor"},
    {name:"Lan Tran", email:"lan.tran@company.com", id:"U002", dept:"PE", role:"Approver"},
    {name:"Quang Le", email:"quang.le@company.com", id:"U003", dept:"FE", role:"Viewer"},
    {name:"Bao Pham", email:"bao.pham@company.com", id:"U004", dept:"QC", role:"Admin"}
  ];
  localStorage.setItem('ecn_users', JSON.stringify(USERS));
}
function saveUsers(){localStorage.setItem('ecn_users',JSON.stringify(USERS));}
function renderUsers(){const tb=document.getElementById('uRows');tb.innerHTML="";USERS.forEach((u,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.id}</td><td>${u.dept}</td><td>${u.role}</td><td><button class="btn secondary" data-i="${i}">Delete</button></td>`;tr.querySelector('button').addEventListener('click',(ev)=>{const idx=+ev.currentTarget.getAttribute('data-i');USERS.splice(idx,1);saveUsers();renderUsers();});tb.appendChild(tr);});}
renderUsers();
document.getElementById('uAdd').addEventListener('click',()=>{const name=uName.value.trim(),email=uEmail.value.trim(),id=uID.value.trim(),dept=uDept.value,role=uRole.value;if(!name||!email||!id){alert("Nhập đầy đủ Họ & Tên, Email, ID");return;}USERS.push({name,email,id,dept,role});saveUsers();renderUsers();uName.value="";uEmail.value="";uID.value="";});
const PROMPT_KEY="ecn_ai_prompt"; (function restorePrompt(){const p=localStorage.getItem(PROMPT_KEY)||""; if(document.getElementById('aiPrompt')) document.getElementById('aiPrompt').value=p; })();
if(document.getElementById('savePrompt')) document.getElementById('savePrompt').addEventListener('click',()=>{localStorage.setItem(PROMPT_KEY, document.getElementById('aiPrompt').value||""); alert("Saved.");});

// ----- Chatroom demo -----
function renderChat(){const arr=JSON.parse(localStorage.getItem('ecn_chat')||'[]');const log=document.getElementById('chatLog');log.innerHTML="";
  arr.forEach(m=>{const d=document.createElement('div');d.className='chat-bubble '+(m.me?'me':'other');d.innerHTML=`<div>${m.text}</div><div class="chat-sender">${m.me?'You':'Teammate'}</div>`;log.appendChild(d);});log.scrollTop=log.scrollHeight;}
if(!localStorage.getItem('ecn_chat')){
  localStorage.setItem('ecn_chat', JSON.stringify([
    {me:false, text:"Morning team, ECN-1102 is pending QC sign-off."},
    {me:true, text:"Roger. I’ll check WI update for FE today."},
    {me:false, text:"PE confirms ROM master for SMT applied on 2025-08-15."}
  ]));
}
renderChat();
document.getElementById('chatSend').addEventListener('click',()=>{const t=chatTxt.value.trim();if(!t)return;const arr=JSON.parse(localStorage.getItem('ecn_chat')||'[]');arr.push({me:true,text:t});localStorage.setItem('ecn_chat',JSON.stringify(arr));chatTxt.value="";renderChat();});

// ----- Convert BOM -----
function parseDelimited(text){const lines=text.trim().split(/\r?\n/);return lines.map(line=>{const parts=line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)|\t/);return parts.map(s=>s.replace(/^"|"$/g,'').trim());});}
function normalizeBOM(rows){const out=[];rows.forEach(r=>{if(!r.length||r.join('').trim()==="")return;const [p,desc,qty,ref]=[r[0]||"",r[1]||"",r[2]||"",r[3]||""];out.push([p,desc,qty,ref]);});return out;}
function renderBOM(rows){const tb=document.querySelector('#bomOut tbody');tb.innerHTML="";rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`;tb.appendChild(tr);});}
let BOM_ROWS=[];document.getElementById('bomParse').addEventListener('click',()=>{const ta=bomPaste.value.trim();if(ta){BOM_ROWS=normalizeBOM(parseDelimited(ta));renderBOM(BOM_ROWS);return;}const f=bomFile.files[0];if(!f){alert("Select a CSV or paste data.");return;}const reader=new FileReader();reader.onload=e=>{BOM_ROWS=normalizeBOM(parseDelimited(e.target.result));renderBOM(BOM_ROWS);};reader.readAsText(f);});document.getElementById('bomDownload').addEventListener('click',()=>{if(!BOM_ROWS.length){alert("No BOM parsed.");return;}const csv=["PartNo,Description,Qty,RefDes"].concat(BOM_ROWS.map(r=>r.map(x=>`\"${String(x).replaceAll('\"','\"\"')}\"`).join(','))).join("\n");const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download="BOM_Normalized.csv";a.click();URL.revokeObjectURL(url);});

// ----- WI Verify -----
let WI_ECN=[],WI_PAGES=[];function readFileToRows(file,cb){const reader=new FileReader();reader.onload=e=>cb(parseDelimited(e.target.result));reader.readAsText(file);}
document.getElementById('wiRun').addEventListener('click',()=>{const ecnF=wiEcn.files[0],wiF=wiPages.files[0];if(!ecnF||!wiF){alert("Select both ECN Master and WI files.");return;}readFileToRows(ecnF,rows=>{WI_ECN=rows;readFileToRows(wiF,rows2=>{WI_PAGES=rows2;compareWI();});});});
function compareWI(){const mapECN={};WI_ECN.forEach(r=>{const key=(r[0]||"").trim();if(!key)return;mapECN[key]={before:r[1]||"",after:r[2]||""};});const tbody=document.querySelector('#wiTable tbody');tbody.innerHTML="";WI_PAGES.forEach((r,i)=>{const part=(r[0]||"").trim();if(!part)return;const wiVal=(r[1]||"").trim();const m=mapECN[part];let status="NG",note="";if(!m){status="NG";note="Part not in ECN";}else if(m.after===wiVal){status="OK";note="Matched";}else if(m.before===wiVal){status="NG";note="WI not updated";}else{status="NG";note="Mismatch";}const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${part}</td><td>${m?m.after:"-"}</td><td>${wiVal}</td><td>${status}</td><td>${note}</td>`;tr.style.background=status==="OK"?"#ecfdf5":"#fff1f2";tbody.appendChild(tr);});}

// ----- + New ECN staging flow -----
const stagingPanel=document.getElementById('stagingPanel'); let STAGING=[];
btnNew.addEventListener('click',()=>newFile.click());
newFile.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();reader.onload=ev=>{const rows=parseDelimited(ev.target.result);STAGING=[];rows.slice(1).forEach((r,i)=>{const eff=(r[6]||"").trim()||"2025-08-01";STAGING.push({ecnNo:r[0]||("ECN-NEW-"+(i+1)),sub:r[1]||("SUB-NEW-"+(i+1)),model:r[2]||"MDL-310",title:r[3]||"Update",before:r[4]||"OLD-PART",after:r[5]||"NEW-PART",effective:eff,valid:eff,status:r[7]||"Pending",dept:r[8]||"SMT",owner:r[9]||"Uploader",priority:r[10]||"Medium"});});renderStaging();};reader.readAsText(f);});
function renderStaging(){const tb=document.getElementById('stagingRows');tb.innerHTML="";STAGING.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.ecnNo}</td><td>${r.sub}</td><td>${r.model}</td><td>${r.title}</td><td><code>${r.before}</code></td><td><code>${r.after}</code></td><td>${r.effective}</td><td>${r.valid}</td><td>${r.status}</td>`;tb.appendChild(tr);});stagingPanel.classList.toggle('hidden',!STAGING.length);}
confirmImport.addEventListener('click',()=>{if(!STAGING.length){alert("No data in staging.");return;}const start=ECN.length+1;STAGING.forEach((r,i)=>ECN.push({...r,idx:start+i,reason:"Imported",issue:r.effective,history:[{ts:r.effective,by:r.owner||"Uploader",note:"Imported"}],rankL:"B"}));STAGING=[];stagingPanel.classList.add('hidden');renderECN();dashKPIs();alert("Imported to official dataset.");});

// ----- AI Advisor (local rules) -----
const openAI=document.getElementById('openAI'), aiPanel=document.getElementById('aiPanel'), aiBody=document.getElementById('aiBody'), aiAsk=document.getElementById('aiAsk');
openAI.addEventListener('click',()=>{aiPanel.style.display = aiPanel.style.display==='flex' ? 'none':'flex'; aiPanel.style.display = aiPanel.style.display || 'flex';});
document.getElementById('aiSend').addEventListener('click',()=>{
  const q = aiAsk.value.trim(); if(!q) return;
  const p = localStorage.getItem('ecn_ai_prompt') || "(default ECN advisor prompt)";
  const msg = document.createElement('div'); msg.textContent = "You: "+q; aiBody.appendChild(msg);
  let out = "I need ECN id, e.g., ECN-1010";
  const m = q.match(/ECN-\d+/i);
  if(m){
    const id = m[0].toUpperCase();
    const r = ECN.find(x=>x.ecnNo===id);
    if(r){
      if(/status/i.test(q)) out = `${id} → ${r.status} • Effective ${r.effective}`;
      else if(/effective/i.test(q)) out = `${id} → Effective ${r.effective} • Valid BOM ${r.valid}`;
      else if(/latest|change|history/i.test(q)) { const last=r.history[r.history.length-1]; out = `${id} → Latest change ${last.ts} by ${last.by}: ${last.note}`; }
      else out = `${id} → ${r.title} (${r.model}) • ${r.status}`;
    } else out = `${id} not found.`;
  }
  const bot = document.createElement('div'); bot.innerHTML = `<div style="color:#0b1220"><strong>AI:</strong> ${out}</div><div style="color:#64748b;font-size:11px">Prompt: ${p.slice(0,80)}...</div>`;
  aiBody.appendChild(bot); aiBody.scrollTop = aiBody.scrollHeight; aiAsk.value="";
});


// ----- i18n setup (English, Vietnamese, Japanese) -----
const i18nDict = {
  en: {
    "Dashboard":"Dashboard","ECN Master":"ECN Master","Department":"Department","Admin":"Admin",
    "Chatroom":"Chatroom","Convert BOM":"Convert BOM","WI Verify":"WI Verify","KPIs":"KPIs",
    "Pending":"Pending","In Progress":"In Progress","Effective":"Effective","Completed":"Completed",
    "Trends":"Trends","Department × Month Heatmap":"Department × Month Heatmap",
    "Rank":"Rank","ECN No.":"ECN No.","Sub ECN":"Sub ECN","Model":"Model","Title":"Title","Before":"Before","After":"After",
    "Status":"Status","View":"View","Owner":"Owner","Priority":"Priority","High":"High","Medium":"Medium","Low":"Low",
    "Feature Flags & Preferences":"Feature Flags & Preferences","User Management":"User Management",
    "Họ và Tên":"Full Name","Email":"Email","ID":"ID","Role":"Role","Delete":"Delete","Add":"Add",
    "Team Chat":"Team Chat","Convert BOM (CSV)":"Convert BOM (CSV)","Or paste CSV below:":"Or paste CSV below:",
    "WI Verify vs ECN Master":"WI Verify vs ECN Master","ECN Detail":"ECN Detail","Info":"Info","History":"History","Feedback":"Feedback",
    "Ngày issue":"Issue Date","Tiêu đề":"Title","Reason":"Reason","Hiệu lực":"Effective","Trạng thái":"Status",
    "Latest change":"Latest change","Send":"Send","Save Prompt":"Save Prompt"
  },
  vi: {
    "Dashboard":"Bảng tin","ECN Master":"ECN Gốc","Department":"Phòng ban","Admin":"Quản trị",
    "Chatroom":"Trò chuyện","Convert BOM":"Chuyển BOM","WI Verify":"Đối chiếu WI","KPIs":"Chỉ số KPI",
    "Pending":"Đang chờ","In Progress":"Đang xử lý","Effective":"Hiệu lực","Completed":"Hoàn tất",
    "Trends":"Xu hướng","Department × Month Heatmap":"Bản đồ Nhiệt Phòng × Tháng",
    "Rank":"Hạng","ECN No.":"Số ECN","Sub ECN":"ECN phụ","Model":"Model","Title":"Tiêu đề","Before":"Trước","After":"Sau",
    "Status":"Trạng thái","View":"Xem","Owner":"Người phụ trách","Priority":"Ưu tiên","High":"Cao","Medium":"Trung bình","Low":"Thấp",
    "Feature Flags & Preferences":"Tùy chọn & Cờ chức năng","User Management":"Quản lý người dùng",
    "Họ và Tên":"Họ và Tên","Email":"Email","ID":"Mã","Role":"Vai trò","Delete":"Xóa","Add":"Thêm",
    "Team Chat":"Trò chuyện nhóm","Convert BOM (CSV)":"Chuyển BOM (CSV)","Or paste CSV below:":"Hoặc dán CSV dưới đây:",
    "WI Verify vs ECN Master":"Đối chiếu WI với ECN Gốc","ECN Detail":"Chi tiết ECN","Info":"Thông tin","History":"Lịch sử","Feedback":"Phản hồi",
    "Ngày issue":"Ngày phát hành","Tiêu đề":"Tiêu đề","Reason":"Lý do","Hiệu lực":"Hiệu lực","Trạng thái":"Trạng thái",
    "Latest change":"Thay đổi mới nhất","Send":"Gửi","Save Prompt":"Lưu Prompt"
  },
  ja: {
    "Dashboard":"ダッシュボード","ECN Master":"ECNマスター","Department":"部門","Admin":"管理",
    "Chatroom":"チャットルーム","Convert BOM":"BOM変換","WI Verify":"WI検証","KPIs":"KPI",
    "Pending":"保留","In Progress":"進行中","Effective":"有効","Completed":"完了",
    "Trends":"トレンド","Department × Month Heatmap":"部門×月 ヒートマップ",
    "Rank":"ランク","ECN No.":"ECN番号","Sub ECN":"サブECN","Model":"モデル","Title":"タイトル","Before":"変更前","After":"変更後",
    "Status":"状態","View":"表示","Owner":"担当者","Priority":"優先度","High":"高","Medium":"中","Low":"低",
    "Feature Flags & Preferences":"機能フラグと設定","User Management":"ユーザー管理",
    "Họ và Tên":"氏名","Email":"メール","ID":"ID","Role":"役割","Delete":"削除","Add":"追加",
    "Team Chat":"チームチャット","Convert BOM (CSV)":"BOM変換 (CSV)","Or paste CSV below:":"またはCSVを貼り付け:",
    "WI Verify vs ECN Master":"WI vs ECNマスターの検証","ECN Detail":"ECN詳細","Info":"情報","History":"履歴","Feedback":"フィードバック",
    "Ngày issue":"発行日","Tiêu đề":"タイトル","Reason":"理由","Hiệu lực":"有効日","Trạng thái":"状態",
    "Latest change":"最新の変更","Send":"送信","Save Prompt":"プロンプト保存"
  }
};
function applyLang(lang){
  document.querySelectorAll('body *').forEach(el=>{
    if(el.childNodes.length===1 && el.childNodes[0].nodeType===3){
      const txt=el.textContent.trim();
      if(i18nDict[lang][txt]) el.textContent=i18nDict[lang][txt];
    }
    if(el.placeholder && i18nDict[lang][el.placeholder]) el.placeholder=i18nDict[lang][el.placeholder];
    if(el.value && i18nDict[lang][el.value]) el.value=i18nDict[lang][el.value];
  });
}
function setLang(lang){
  localStorage.setItem('ecn_lang', lang);
  applyLang(lang);
  document.getElementById('langTop').value=lang;
  document.getElementById('lang').value=lang;
}
document.getElementById('langTop').addEventListener('change', e=>setLang(e.target.value));
document.getElementById('lang').addEventListener('change', e=>setLang(e.target.value));
(function(){const L=localStorage.getItem('ecn_lang')||'en';setLang(L);})();

// ===== I18N Runtime Fix (3 languages only + reversible switching) =====
(function(){
  const LANG_KEY = 'ecn_lang';
  const OPTIONS_HTML = '<option value="en">English</option><option value="vi">Tiếng Việt</option><option value="ja">日本語</option>';

  // Dictionaries: source keys are the ORIGINAL English strings taken from the DOM on first load.
  const I18N = {
    en: {}, // english returns original
    vi: {
      "Dashboard":"Bảng tin","ECN Master":"ECN Gốc","Department":"Phòng ban","Admin":"Quản trị",
      "Chatroom":"Trò chuyện","Convert BOM":"Chuyển BOM","WI Verify":"Đối chiếu WI","KPIs":"Chỉ số KPI",
      "Pending":"Đang chờ","In Progress":"Đang xử lý","Effective":"Hiệu lực","Completed":"Hoàn tất",
      "Trends":"Xu hướng","Department × Month Heatmap":"Bản đồ Nhiệt Phòng × Tháng",
      "Rank":"Hạng","ECN No.":"Số ECN","Sub ECN":"ECN phụ","Model":"Model","Title":"Tiêu đề","Before":"Trước","After":"Sau",
      "Status":"Trạng thái","View":"Xem","Owner":"Người phụ trách","Priority":"Ưu tiên","High":"Cao","Medium":"Trung bình","Low":"Thấp",
      "Feature Flags & Preferences":"Tùy chọn & Cờ chức năng","User Management":"Quản lý người dùng",
      "Full Name":"Họ và Tên","Email":"Email","ID":"Mã","Role":"Vai trò","Delete":"Xóa","Add":"Thêm",
      "Team Chat":"Trò chuyện nhóm","Convert BOM (CSV)":"Chuyển BOM (CSV)","Or paste CSV below:":"Hoặc dán CSV dưới đây:",
      "WI Verify vs ECN Master":"Đối chiếu WI với ECN Gốc","ECN Detail":"Chi tiết ECN","Info":"Thông tin","History":"Lịch sử","Feedback":"Phản hồi",
      "Issue Date":"Ngày phát hành","Reason":"Lý do","Latest change":"Thay đổi mới nhất","Save Prompt":"Lưu Prompt","Send":"Gửi"
    },
    ja: {
      "Dashboard":"ダッシュボード","ECN Master":"ECNマスター","Department":"部門","Admin":"管理",
      "Chatroom":"チャットルーム","Convert BOM":"BOM変換","WI Verify":"WI検証","KPIs":"KPI",
      "Pending":"保留","In Progress":"進行中","Effective":"有効","Completed":"完了",
      "Trends":"トレンド","Department × Month Heatmap":"部門×月 ヒートマップ",
      "Rank":"ランク","ECN No.":"ECN番号","Sub ECN":"サブECN","Model":"モデル","Title":"タイトル","Before":"変更前","After":"変更後",
      "Status":"状態","View":"表示","Owner":"担当者","Priority":"優先度","High":"高","Medium":"中","Low":"低",
      "Feature Flags & Preferences":"機能フラグと設定","User Management":"ユーザー管理",
      "Full Name":"氏名","Email":"メール","ID":"ID","Role":"役割","Delete":"削除","Add":"追加",
      "Team Chat":"チームチャット","Convert BOM (CSV)":"BOM変換 (CSV)","Or paste CSV below:":"またはCSVを貼り付け:",
      "WI Verify vs ECN Master":"WI vs ECNマスターの検証","ECN Detail":"ECN詳細","Info":"情報","History":"履歴","Feedback":"フィードバック",
      "Issue Date":"発行日","Reason":"理由","Latest change":"最新の変更","Save Prompt":"プロンプト保存","Send":"送信"
    }
  };

  function sanitizeLanguageSelects(){
    const a = document.getElementById('langTop');
    const b = document.getElementById('lang');
    if(a){ a.innerHTML = OPTIONS_HTML; }
    if(b){ b.innerHTML = OPTIONS_HTML; }
  }

  // Cache original (English) text/placeholder/value once
  let cached = false;
  function cacheOriginalStrings(){
    if(cached) return;
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
    while(walker.nextNode()){
      const el = walker.currentNode;
      // textContent (simple leaf text nodes)
      if(!el.children.length && el.childNodes.length===1 && el.childNodes[0].nodeType===3){
        const txt = el.textContent.trim();
        if(el.classList && el.classList.contains('v')) { /* skip KPI value cells */ }
        else if(/^[0-9.,]+$/.test(txt)) { /* skip pure numbers */ }
        else if(!el.dataset.i18nEn && txt){ el.dataset.i18nEn = el.textContent; }
      }
      // placeholder
      if(el.placeholder && !el.dataset.i18nPhEn){
        el.dataset.i18nPhEn = el.placeholder;
      }
      // value (for buttons)
      if((el.tagName==='INPUT' || el.tagName==='BUTTON') && el.value && !el.dataset.i18nValEn && el.id!=='q'){
        el.dataset.i18nValEn = el.value;
      }
    }
    cached = true;
  }

  function applyLang(lang){
    cacheOriginalStrings();
    const dict = I18N[lang] || {};
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
    while(walker.nextNode()){
      const el = walker.currentNode;
      // text node
      if(el.dataset && el.dataset.i18nEn){
        const base = el.dataset.i18nEn.trim();
        el.textContent = (lang==='en') ? base : (dict[base] || base);
      }
      // placeholder
      if(el.dataset && el.dataset.i18nPhEn){
        const basePh = el.dataset.i18nPhEn;
        el.placeholder = (lang==='en') ? basePh : (dict[basePh] || basePh);
      }
      // value (buttons/inputs)
      if(el.dataset && el.dataset.i18nValEn){
        const baseVal = el.dataset.i18nValEn;
        el.value = (lang==='en') ? baseVal : (dict[baseVal] || baseVal);
      }
    }
    localStorage.setItem(LANG_KEY, lang);
    const a = document.getElementById('langTop'); if(a) a.value = lang;
    const b = document.getElementById('lang'); if(b) b.value = lang;
  }

  function getLang(){ return localStorage.getItem(LANG_KEY) || 'en'; }
  function onLangChange(ev){ applyLang(ev.target.value); if(typeof dashKPIs==='function') try{ dashKPIs(); }catch(e){} window.dispatchEvent(new Event('ecn_lang_changed')); }

  document.addEventListener('DOMContentLoaded', function(){
    sanitizeLanguageSelects();
    const a = document.getElementById('langTop'); const b = document.getElementById('lang');
    if(a){ a.addEventListener('change', onLangChange); }
    if(b){ b.addEventListener('change', onLangChange); }
    applyLang(getLang());
    if(typeof dashKPIs==='function') try{ dashKPIs(); }catch(e){}
    window.dispatchEvent(new Event('ecn_lang_changed'));
  });
})();

// --- KPI runtime adjust: compute Total and order 4 cards without touching HTML structure
(function(){
  const oldDashKPIs = typeof dashKPIs==='function' ? dashKPIs : null;
  window.dashKPIs = function(){
    if(oldDashKPIs) oldDashKPIs();
    // Compute totals
    const k = {Pending:0,"In progress":0,Completed:0};
    if(Array.isArray(window.ECN)){
      window.ECN.forEach(r=>{ if(k[r.status]!==undefined) k[r.status]++; });
    }
    const total = k.Pending + k["In progress"] + k.Completed;
    const $ = id => document.getElementById(id);
    if($('kArchived')) $('kArchived').textContent = k.Completed;
    if($('kPending')) $('kPending').textContent = k.Pending;
    if($('kProgress')) $('kProgress').textContent = k["In progress"];
    // Ensure Total KPI exists (create once)
    if(!$('kTotal')){
      const grid = document.querySelector('.kpi-grid');
      if(grid){
        const card = document.createElement('div');
        card.className = 'kpi';
        card.innerHTML = '<div class="k">Total ECN</div><div class="v" id="kTotal">0</div>';
        grid.insertBefore(card, grid.firstChild);
      }
    }
    if($('kTotal')) $('kTotal').textContent = total;
    // Reorder: Total, Pending, In progress, Completed
    const grid = document.querySelector('.kpi-grid');
    if(grid){
      const order = ['kTotal','kPending','kProgress','kArchived'];
      order.forEach(id=>{ const v = $(id); if(v && v.parentElement && v.parentElement.parentElement===grid){ grid.appendChild(v.parentElement); } });
    }
  };
  // Run once after page init (in case charts/app already loaded)
  try{ window.dashKPIs(); }catch(e){}
})();

// ---- KPI unify counts with monthly data ----
(function(){
  const _dashKPIs = (typeof window.dashKPIs==='function') ? window.dashKPIs : null;
  window.dashKPIs = function(){
    if(_dashKPIs) _dashKPIs();
    const k={Pending:0,"In progress":0,Completed:0};
    const list = Array.isArray(window.ECN) ? window.ECN : [];
    for(const r of list){ if(k[r.status]!==undefined) k[r.status]++; }
    const total = list.length; // must equal sum of bar chart monthly totals
    const $ = id => document.getElementById(id);
    if($('kPending')) $('kPending').textContent = k.Pending;
    if($('kProgress')) $('kProgress').textContent = k["In progress"];
    if($('kArchived')) $('kArchived').textContent = k.Completed;
    if($('kTotal')) $('kTotal').textContent = total;
  };
  try{ window.dashKPIs(); }catch(e){}
})();

// ---- Department page: i18n label fix + column reorder ----
(function(){
  const LABELS = {
    en:{ dept:"Department", owner:"Owner", ownerPh:"Owner name", prio:"Priority", all:"All", rm:"ROM master", ad:"Apply date", status:"Status", view:"View", valid:"Valid BOM" },
    vi:{ dept:"Phòng ban", owner:"Owner", ownerPh:"Tên phụ trách", prio:"Ưu tiên", all:"Tất cả", rm:"ROM master", ad:"Ngày áp dụng", status:"Trạng thái", view:"Xem", valid:"Valid BOM" },
    ja:{ dept:"部門", owner:"担当者", ownerPh:"担当者名", prio:"優先度", all:"すべて", rm:"ROMマスター", ad:"適用日", status:"状態", view:"表示", valid:"Valid BOM" }
  };
  function lang(){ return localStorage.getItem('ecn_lang')||'en'; }

  function applyDeptLabels(){
    const L = LABELS[lang()];
    // Filter labels
    const w = document.querySelector('#page-department .filters');
    if(!w) return;
    const f = w.querySelectorAll('.filter');
    if(f[0]){ const lab=f[0].querySelector('label,span'); if(lab) lab.textContent = L.dept; }
    if(f[1]){ const lab=f[1].querySelector('label'); if(lab) lab.textContent = L.owner; const inp=f[1].querySelector('input'); if(inp) inp.placeholder=L.ownerPh; }
    if(f[2]){ const lab=f[2].querySelector('label'); if(lab) lab.textContent = L.prio; const sel=f[2].querySelector('select'); if(sel){ const o=sel.querySelectorAll('option'); if(o[0]) o[0].textContent=L.all; } }
  }

  function reorderDeptColumns(){
    const page = document.getElementById('page-department'); if(!page) return;
    const table = page.querySelector('table'); if(!table) return;
    const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody'); if(!thead||!tbody) return;
    const headCells = Array.from(thead.querySelectorAll('tr.taskbar th'));
    if(!headCells.length) return;

    // Map header text (trimmed) to index
    const idx = {};
    headCells.forEach((th,i)=> idx[th.textContent.trim()] = i);

    // Resolve indices by trying labels in all languages
    const L = LABELS[lang()];
    const getIdx = (names)=>{
      for(const n of names){ if(n in idx) return idx[n]; }
      return -1;
    };
    const iValid = getIdx([L.valid,"Valid BOM"]);
    const iRM = getIdx([L.rm,"ROM master","ROMマスター"]);
    const iAD = getIdx([L.ad,"Apply date","適用日"]);
    const iStatus = getIdx([L.status,"Trạng thái","状態","Status"]);
    const iView = getIdx([L.view,"Xem","表示","View"]);
    if(iValid<0 || iRM<0 || iAD<0 || iStatus<0 || iView<0) return; // columns not present

    // Desired new order parts:
    // ... [up to iValid] then ROM master, Apply date, then other mid columns (excluding Status/View), finally Status, View
    const order = [];
    const n = headCells.length;
    // Collect base columns before Valid BOM (inclusive)
    for(let c=0;c<=iValid;c++) order.push(c);
    // Then ROM master & Apply date (if not already right position)
    if(!order.includes(iRM)) order.push(iRM);
    if(!order.includes(iAD)) order.push(iAD);
    // Then remaining columns except Status/View and ones already added
    for(let c=iValid+1;c<n;c++){ if(![iRM,iAD,iStatus,iView].includes(c) && !order.includes(c)) order.push(c); }
    // Finally Status then View
    if(!order.includes(iStatus)) order.push(iStatus);
    if(!order.includes(iView)) order.push(iView);

    // Apply header reorder
    const trHead = thead.querySelector('tr.taskbar');
    const headClones = Array.from(headCells);
    trHead.innerHTML = "";
    order.forEach(i=> trHead.appendChild(headClones[i]));

    // Apply each row reorder
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const cells = Array.from(tr.children);
      const frag = document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(cells[i]));
      tr.innerHTML = "";
      tr.appendChild(frag);
    });
  }

  // Run when department page is visible
  function runDeptFix(){
    applyDeptLabels();
    reorderDeptColumns();
  }

  // Observe navigation and rerun when page changes language or tab
  document.addEventListener('click', function(ev){
    if(ev.target.closest('.nav-item')) setTimeout(runDeptFix, 80);
  });
  document.addEventListener('DOMContentLoaded', runDeptFix);
  window.addEventListener('ecn_lang_changed', runDeptFix);
})();

// ---- Show "+ New ECN" only on ECN Master ----
(function(){
  const btn = document.getElementById('btnNew');
  if(!btn) return;
  function update(){
    const master = document.getElementById('page-ecnMaster');
    const visible = master && (master.style.display!== 'none') && master.offsetParent !== null;
    btn.style.display = visible ? '' : 'none';
  }
  document.addEventListener('click', function(ev){
    if(ev.target.closest('.nav-item')) setTimeout(update, 100);
  });
  document.addEventListener('DOMContentLoaded', update);
})();

// Ensure Department columns are reordered on first load as soon as rows appear
(function(){
  const targetPage = document.getElementById('page-department');
  if(!targetPage) return;
  const table = targetPage.querySelector('table');
  if(!table) return;
  const tbody = table.querySelector('tbody');
  if(!tbody) return;
  let appliedOnce = false;
  const observer = new MutationObserver(()=>{
    if(appliedOnce) return;
    if(tbody.children.length>0){
      try{ (window.__runDeptFix||function(){})(); appliedOnce = true; }catch(e){}
    }
  });
  observer.observe(tbody,{childList:true});
  // expose runner so other code can call
  window.__runDeptFix = function(){ try{ runDeptFix(); }catch(e){} };
  // also attempt once in case rows already there
  setTimeout(()=>{ if(tbody.children.length>0){ window.__runDeptFix(); appliedOnce=true; } }, 120);
})();

// Stable KPI: order + values (run at load, on tab show, after charts, and on language change)
(function(){
  function computeCounts(){
    const counts={Pending:0,"In progress":0,Completed:0};
    const list = Array.isArray(window.ECN)? window.ECN : [];
    for(const r of list){ if(counts[r.status]!==undefined) counts[r.status]++; }
    let total = 0;
    if(Array.isArray(window.monthlyTotals) && window.monthlyTotals.length){
      total = window.monthlyTotals.reduce((a,b)=>a+(+b||0),0);
    }else{
      total = list.length;
    }
    return {counts,total};
  }
  function ensureTilesAndOrder(){
    const grid = document.querySelector('#page-dashboard .kpi-grid');
    if(!grid) return;
    const get = id=>document.getElementById(id);
    // Create Total tile if missing
    if(!get('kTotal')){
      const card=document.createElement('div');
      card.className='kpi';
      card.innerHTML='<div class="k">Total ECN</div><div class="v" id="kTotal">0</div>';
      grid.insertBefore(card, grid.firstChild);
    }
    // Reorder in desired order
    const order=['kTotal','kPending','kProgress','kArchived'];
    order.forEach(id=>{
      const v=get(id);
      if(v && v.parentElement && v.parentElement.parentElement===grid) grid.appendChild(v.parentElement);
    });
  }
  function render(){
    ensureTilesAndOrder();
    const {counts,total}=computeCounts();
    const set=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=String(val); };
    set('kTotal', total);
    set('kPending', counts.Pending);
    set('kProgress', counts["In progress"]);
    set('kArchived', counts.Completed);
  }
  // Hook into existing functions if present
  const oldDashCharts = (typeof window.dashCharts==='function')? window.dashCharts : null;
  if(oldDashCharts){
    window.dashCharts = function(){ oldDashCharts(); try{ render(); }catch(e){} };
  }
  const oldDashKPIs = (typeof window.dashKPIs==='function')? window.dashKPIs : null;
  window.dashKPIs = function(){ if(oldDashKPIs) oldDashKPIs(); try{ render(); }catch(e){} };
  // Run on load and when switching to dashboard tab
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(render, 100); });
  document.addEventListener('click', function(ev){
    if(ev.target.closest('.nav-item[data-nav="dashboard"]')) setTimeout(render, 120);
  });
  // Re-render after language change
  window.addEventListener('ecn_lang_changed', function(){ setTimeout(render, 60); });
})();

// === Department page enhancements applied ===
// ----- Init -----
function initAll(){
  dashKPIs(); dashCharts();
  renderECN();
  renderDeptTable();
}
if(document.readyState==="complete") initAll(); else window.addEventListener('load', initAll);
</script>

<!-- SAFE7 minimal Department search + reorder -->
<script>
(function(){
  // Utils
  function isDeptActive(){
    const page = document.getElementById('page-department');
    return page && page.style.display !== 'none';
  }
  function norm(t){ return String(t||'').replace(/\s+/g,' ').trim(); }

  // Reorder Department columns: ROM master + Apply date immediately after Valid BOM; Status & View at the end
  function reorderDeptCols(){
    const page = document.getElementById('page-department'); if(!page) return;
    const table = page.querySelector('table'); if(!table) return;
    const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody');
    if(!thead || !tbody) return;
    const trHead = thead.querySelector('tr.taskbar'); if(!trHead) return;
    const ths = Array.from(trHead.children);
    if(!ths.length) return;

    // Recognize labels in EN/VI/JA
    const labels = {
      valid: ["Valid BOM","Valid BOM","Valid BOM"], // keep variants
      rom: ["ROM master","ROMマスター","ROM master"],
      apply: ["Apply date","Ngày áp dụng","適用日"],
      status: ["Status","Trạng thái","状態"],
      view: ["View","Xem","表示"]
    };
    const findIdx = (names)=>{
      let idx=-1;
      ths.forEach((th,i)=>{
        const txt = norm(th.textContent);
        names.forEach(n=>{ if(idx<0 && norm(n)===txt) idx=i; });
      });
      return idx;
    };
    const iValid = findIdx(labels.valid);
    const iROM = findIdx(labels.rom);
    const iApply = findIdx(labels.apply);
    const iStatus = findIdx(labels.status);
    const iView = findIdx(labels.view);
    if(iValid<0 || iStatus<0 || iView<0) return; // nothing to do

    // Build order
    const N = ths.length;
    const order = [];
    for(let i=0;i<=iValid;i++) order.push(i);                // up to Valid BOM
    if(iROM>=0 && !order.includes(iROM)) order.push(iROM);   // ROM master
    if(iApply>=0 && !order.includes(iApply)) order.push(iApply); // Apply date
    for(let i=iValid+1;i<N;i++){                             // rest except Status/View and already added
      if([iROM,iApply,iStatus,iView].includes(i)) continue;
      if(!order.includes(i)) order.push(i);
    }
    if(!order.includes(iStatus)) order.push(iStatus);        // Status
    if(!order.includes(iView)) order.push(iView);            // View

    // Apply to header
    const headCells = Array.from(trHead.children);
    trHead.innerHTML = "";
    order.forEach(i=> trHead.appendChild(headCells[i]));

    // Apply to rows
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const tds = Array.from(tr.children);
      const frag = document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(tds[i]));
      tr.innerHTML = "";
      tr.appendChild(frag);
    });

    // Center Status column
    const newIdxStatus = order.indexOf(iStatus);
    if(newIdxStatus>=0){
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const td = tr.children[newIdxStatus]; if(td) td.style.textAlign = 'center';
      });
    }
  }

  // Department search by top input #q
  function attachDeptSearch(){
    const q = document.getElementById('q'); if(!q || q.__deptBound) return;
    q.__deptBound = true;
    q.addEventListener('input', function(){
      if(!isDeptActive()) return; // only when Department tab visible
      const val = this.value.trim().toLowerCase();
      const page = document.getElementById('page-department');
      const tbody = page ? page.querySelector('tbody') : null;
      if(!tbody) return;
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const txt = tr.textContent.toLowerCase();
        tr.style.display = val ? (txt.includes(val) ? '' : 'none') : '';
      });
    });
  }

  // Run on first Department render (rows arrive async)
  function watchDeptFirstRender(){
    const page = document.getElementById('page-department'); if(!page) return;
    const tbody = page.querySelector('tbody'); if(!tbody) return;
    let done = false;
    const obs = new MutationObserver(()=>{
      if(done) return;
      if(tbody.children.length>0){
        try{ reorderDeptCols(); }catch(e){}
        done = true;
      }
    });
    obs.observe(tbody,{childList:true});
  }

  // Hooks
  document.addEventListener('DOMContentLoaded', function(){
    attachDeptSearch();
    watchDeptFirstRender();
  });
  // When switching tabs or language, try again
  document.addEventListener('click', function(ev){
    const nav = ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){
      setTimeout(function(){
        attachDeptSearch();
        reorderDeptCols();
      }, 80);
    }
  });
  window.addEventListener('ecn_lang_changed', function(){
    setTimeout(function(){ reorderDeptCols(); }, 60);
  });
})();
</script>


<!-- SAFE8 fix: Department i18n + refresh data render -->
<script>
(function(){
  const LABELS = {
    en:{ rank:"Rank", ecn:"ECN No.", sub:"Sub ECN", model:"Model", title:"Title",
         before:"Before", after:"After", eff:"Effective", valid:"Valid BOM",
         rom:"ROM master", apply:"Apply date", status:"Status", view:"View" },
    vi:{ rank:"Hạng", ecn:"Số ECN", sub:"ECN phụ", model:"Model", title:"Tiêu đề",
         before:"Trước", after:"Sau", eff:"Hiệu lực", valid:"Valid BOM",
         rom:"ROM master", apply:"Ngày áp dụng", status:"Trạng thái", view:"Xem" },
    ja:{ rank:"ランク", ecn:"ECN番号", sub:"サブECN", model:"モデル", title:"タイトル",
         before:"変更前", after:"変更後", eff:"有効日", valid:"Valid BOM",
         rom:"ROMマスター", apply:"適用日", status:"状態", view:"表示" }
  };
  const VARIANTS = {
    rank:["Rank","Hạng","ランク"],
    ecn:["ECN No.","Số ECN","ECN番号"],
    sub:["Sub ECN","ECN phụ","サブECN"],
    model:["Model","Model","モデル"],
    title:["Title","Tiêu đề","タイトル"],
    before:["Before","Trước","変更前"],
    after:["After","Sau","変更後"],
    eff:["Effective","Hiệu lực","有効日"],
    valid:["Valid BOM","Valid BOM","Valid BOM"],
    rom:["ROM master","ROMマスター","ROM master"],
    apply:["Apply date","Ngày áp dụng","適用日"],
    status:["Status","Trạng thái","状態"],
    view:["View","Xem","表示"]
  };
  function curLang(){ return localStorage.getItem('ecn_lang') || 'en'; }
  function norm(s){ return String(s||'').replace(/\s+/g,' ').trim(); }
  function localizeDeptHead(){
    const page = document.getElementById('page-department'); if(!page) return;
    const ths = page.querySelectorAll('thead tr.taskbar th'); if(!ths.length) return;
    const L = LABELS[curLang()] || LABELS.en;
    ths.forEach(th=>{
      const txt = norm(th.textContent);
      let key=null;
      for(const k in VARIANTS){
        if(VARIANTS[k].some(v=> norm(v)===txt )){ key=k; break; }
      }
      if(key && L[key]) th.textContent = L[key];
    });
  }
  function hookLanguageEvents(){
    const ids=['langTop','lang'];
    ids.forEach(id=>{
      const sel = document.getElementById(id);
      if(sel && !sel.__safe8Hook){
        sel.__safe8Hook = true;
        sel.addEventListener('change', ()=>{
          setTimeout(()=>{
            try{ localizeDeptHead(); }catch(e){}
            try{ window.dispatchEvent(new Event('ecn_lang_changed')); }catch(e){}
          }, 10);
        });
      }
    });
  }
  function ensureDeptData(){
    const sel = document.getElementById('dDept');
    if(sel && !sel.value && sel.options && sel.options.length){
      sel.value = sel.options[0].value;
    }
    if(typeof window.renderDeptTable === 'function'){
      try{ window.renderDeptTable(); }catch(e){}
    }
  }
  function watchDeptFirstRender(){
    const page = document.getElementById('page-department'); if(!page) return;
    const tbody = page.querySelector('tbody'); if(!tbody) return;
    let done=false;
    const obs = new MutationObserver(()=>{
      if(done) return;
      if(tbody.children.length>0){
        try{ localizeDeptHead(); }catch(e){}
        done=true;
      }
    });
    obs.observe(tbody,{childList:true});
  }
  document.addEventListener('DOMContentLoaded', function(){
    hookLanguageEvents();
    setTimeout(ensureDeptData, 120);
    setTimeout(localizeDeptHead, 150);
    watchDeptFirstRender();
  });
  document.addEventListener('click', function(ev){
    const nav = ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){
      setTimeout(()=>{ ensureDeptData(); localizeDeptHead(); }, 80);
    }
  });
  window.addEventListener('ecn_lang_changed', function(){
    setTimeout(localizeDeptHead, 60);
  });
})();
</script>


<!-- SAFE8.orderfix: lock Department column order & status/view at end -->
<script>
(function(){
  function norm(t){ return String(t||'').replace(/\s+/g,' ').trim(); }
  function fixDeptOrder(){
    const page = document.getElementById('page-department'); if(!page) return;
    const table = page.querySelector('table'); if(!table) return;
    const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody');
    if(!thead || !tbody) return;
    const trHead = thead.querySelector('tr.taskbar'); if(!trHead) return;
    const ths = Array.from(trHead.children); if(!ths.length) return;

    const labels = {
      valid: ["Valid BOM","Valid BOM","Valid BOM"],
      rom: ["ROM master","ROMマスター","ROM master","ROM マスター"],
      apply: ["Apply date","Ngày áp dụng","適用日"],
      status: ["Status","Trạng thái","状態"],
      view: ["View","Xem","表示"]
    };
    const findIdx = (names)=>{
      let idx=-1;
      ths.forEach((th,i)=>{ const txt=norm(th.textContent); names.forEach(n=>{ if(idx<0 && norm(n)===txt) idx=i; }); });
      return idx;
    };
    const iValid = findIdx(labels.valid);
    const iROM   = findIdx(labels.rom);
    const iApply = findIdx(labels.apply);
    const iStatus= findIdx(labels.status);
    const iView  = findIdx(labels.view);
    if(iValid<0 || iStatus<0 || iView<0) return;

    const N = ths.length;
    const order = [];
    for(let i=0;i<=iValid;i++) order.push(i);               // up to Valid BOM
    if(iROM>=0 && !order.includes(iROM)) order.push(iROM);  // ROM master
    if(iApply>=0 && !order.includes(iApply)) order.push(iApply); // Apply date
    for(let i=iValid+1;i<N;i++){                             // others, skip status/view if later
      if([iROM,iApply,iStatus,iView].includes(i)) continue;
      if(!order.includes(i)) order.push(i);
    }
    if(!order.includes(iStatus)) order.push(iStatus);        // Status
    if(!order.includes(iView)) order.push(iView);            // View

    // apply header
    const headCells = Array.from(trHead.children);
    const fragH = document.createDocumentFragment();
    order.forEach(i=> fragH.appendChild(headCells[i]));
    trHead.innerHTML=""; trHead.appendChild(fragH);

    // apply rows
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const tds = Array.from(tr.children);
      const frag = document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(tds[i]));
      tr.innerHTML=""; tr.appendChild(frag);
    });

    // center the Status column
    const newIdxStatus = order.indexOf(iStatus);
    if(newIdxStatus>=0){
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const td = tr.children[newIdxStatus]; if(td) td.style.textAlign='center';
      });
    }
  }

  // Run once rows appear & rerun on mutations (lock order even after re-render)
  function lockDeptOrder(){
    const page = document.getElementById('page-department'); if(!page) return;
    const tbody = page.querySelector('#deptRows'); if(!tbody) return;
    fixDeptOrder();
    if(tbody.__orderLocked) return;
    tbody.__orderLocked = true;
    const obs = new MutationObserver(()=> fixDeptOrder());
    obs.observe(tbody,{childList:true});
  }

  document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(lockDeptOrder, 120); });
  document.addEventListener('click', (ev)=>{
    const nav = ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){ setTimeout(lockDeptOrder, 60); }
  });
  window.addEventListener('ecn_lang_changed', ()=>{ setTimeout(lockDeptOrder, 60); });
})();
</script>


<!-- SAFE8.orderfix2: keep Department data when switching language -->
<script>
(function(){
  function ensureDeptData(){
    const sel = document.getElementById('dDept');
    if(sel && !sel.value && sel.options && sel.options.length){
      sel.value = sel.options[0].value;
    }
    if(typeof window.renderDeptTable === 'function'){
      try{ window.renderDeptTable(); }catch(e){}
    }
  }
  // When language changes, re-render department rows (data sometimes cleared by other i18n updates)
  window.addEventListener('ecn_lang_changed', function(){
    // Wait a tick for labels to swap, then render and lock order again
    setTimeout(function(){
      try{ ensureDeptData(); }catch(e){}
      // if table still empty, one more attempt shortly after
      setTimeout(function(){
        const tbody = document.querySelector('#page-department #deptRows');
        if(tbody && tbody.children.length===0){ try{ ensureDeptData(); }catch(e){} }
      }, 120);
    }, 60);
  });
})();
</script>


<!-- SAFE8_compact: Department search + i18n header + order lock + data render on lang/tab -->
<script>
(function(){
  function norm(t){ return String(t||'').replace(/\s+/g,' ').trim(); }
  function isDeptActive(){ const p=document.getElementById('page-department'); return p && p.style.display!=='none'; }

  // ===== i18n for Department header (EN/VI/JA) =====
  const LABELS = {
    en:{ rank:"Rank", ecn:"ECN No.", sub:"Sub ECN", model:"Model", title:"Title",
         before:"Before", after:"After", eff:"Effective", valid:"Valid BOM",
         rom:"ROM master", apply:"Apply date", status:"Status", view:"View" },
    vi:{ rank:"Hạng", ecn:"Số ECN", sub:"ECN phụ", model:"Model", title:"Tiêu đề",
         before:"Trước", after:"Sau", eff:"Hiệu lực", valid:"Valid BOM",
         rom:"ROM master", apply:"Ngày áp dụng", status:"Trạng thái", view:"Xem" },
    ja:{ rank:"ランク", ecn:"ECN番号", sub:"サブECN", model:"モデル", title:"タイトル",
         before:"変更前", after:"変更後", eff:"有効日", valid:"Valid BOM",
         rom:"ROMマスター", apply:"適用日", status:"状態", view:"表示" }
  };
  const VARS = {
    rank:["Rank","Hạng","ランク"], ecn:["ECN No.","Số ECN","ECN番号"], sub:["Sub ECN","ECN phụ","サブECN"],
    model:["Model","Model","モデル"], title:["Title","Tiêu đề","タイトル"], before:["Before","Trước","変更前"],
    after:["After","Sau","変更後"], eff:["Effective","Hiệu lực","有効日"], valid:["Valid BOM","Valid BOM","Valid BOM"],
    rom:["ROM master","ROMマスター","ROM master","ROM マスター"], apply:["Apply date","Ngày áp dụng","適用日"],
    status:["Status","Trạng thái","状態"], view:["View","Xem","表示"]
  };
  function curLang(){ return localStorage.getItem('ecn_lang') || 'en'; }
  function localizeDeptHead(){
    const page=document.getElementById('page-department'); if(!page) return;
    const ths=page.querySelectorAll('thead tr.taskbar th'); if(!ths.length) return;
    const L=LABELS[curLang()]||LABELS.en;
    ths.forEach(th=>{
      const txt=norm(th.textContent); let key=null;
      for(const k in VARS){ if(VARS[k].some(v=>norm(v)===txt)){ key=k; break; } }
      if(key && L[key]) th.textContent=L[key];
    });
  }

  // ===== Lock column order (ROM master & Apply date right after Valid BOM; Status & View at end) =====
  function fixDeptOrder(){
    const page=document.getElementById('page-department'); if(!page) return;
    const table=page.querySelector('table'); if(!table) return;
    const thead=table.querySelector('thead'), tbody=table.querySelector('tbody');
    if(!thead||!tbody) return;
    const trHead=thead.querySelector('tr.taskbar'); if(!trHead) return;
    const ths=Array.from(trHead.children); if(!ths.length) return;

    const find=(names)=>{ let idx=-1; ths.forEach((th,i)=>{ const t=norm(th.textContent); names.forEach(n=>{ if(idx<0 && norm(n)===t) idx=i; }); }); return idx; };
    const iValid=find(VARS.valid), iROM=find(VARS.rom), iApply=find(VARS.apply), iStatus=find(VARS.status), iView=find(VARS.view);
    if(iValid<0 || iStatus<0 || iView<0) return;

    const N=ths.length, order=[];
    for(let i=0;i<=iValid;i++) order.push(i);
    if(iROM>=0 && !order.includes(iROM)) order.push(iROM);
    if(iApply>=0 && !order.includes(iApply)) order.push(iApply);
    for(let i=iValid+1;i<N;i++){ if([iROM,iApply,iStatus,iView].includes(i)) continue; if(!order.includes(i)) order.push(i); }
    if(!order.includes(iStatus)) order.push(iStatus);
    if(!order.includes(iView)) order.push(iView);

    const headCells=Array.from(trHead.children), fragH=document.createDocumentFragment(); trHead.innerHTML="";
    order.forEach(i=> fragH.appendChild(headCells[i])); trHead.appendChild(fragH);
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const tds=Array.from(tr.children), frag=document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(tds[i])); tr.innerHTML=""; tr.appendChild(frag);
    });
    const idxS=order.indexOf(iStatus);
    if(idxS>=0){ Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{ const td=tr.children[idxS]; if(td) td.style.textAlign='center'; }); }
  }
  function lockDeptOrder(){
    const tbody=document.querySelector('#page-department #deptRows'); if(!tbody) return;
    fixDeptOrder();
    if(tbody.__lockObs) return;
    const obs=new MutationObserver(()=>fixDeptOrder()); obs.observe(tbody,{childList:true}); tbody.__lockObs=obs;
  }

  // ===== Department search using top #q when Department is visible =====
  function attachDeptSearch(){
    const q=document.getElementById('q'); if(!q || q.__deptBound) return;
    q.__deptBound=true;
    q.addEventListener('input', function(){
      if(!isDeptActive()) return;
      const val=this.value.trim().toLowerCase();
      const tb=document.querySelector('#page-department tbody'); if(!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const txt=tr.textContent.toLowerCase();
        tr.style.display = val ? (txt.includes(val)?'':'none') : '';
      });
    });
  }

  // ===== Ensure data exists on refresh / language change =====
  function ensureDeptData(){
    const sel=document.getElementById('dDept'); if(sel && !sel.value && sel.options && sel.options.length) sel.value=sel.options[0].value;
    if(typeof window.renderDeptTable==='function'){ try{ window.renderDeptTable(); }catch(e){} }
  }

  // Hooks
  document.addEventListener('DOMContentLoaded', ()=>{
    attachDeptSearch();
    setTimeout(()=>{ ensureDeptData(); localizeDeptHead(); lockDeptOrder(); }, 120);
  });
  document.addEventListener('click', (ev)=>{
    const nav=ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){ setTimeout(()=>{ attachDeptSearch(); ensureDeptData(); localizeDeptHead(); lockDeptOrder(); }, 80); }
  });
  window.addEventListener('ecn_lang_changed', ()=>{ setTimeout(()=>{ ensureDeptData(); localizeDeptHead(); lockDeptOrder(); }, 80); });
})();
</script>



<!-- FIX_ULTRA_CLEAN2: normalize Priority filter values (avoid empty Department in VI/JA) -->
<script>
(function(){
  function norm(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

  function normalizeDeptPriorityValues(){
    var sel = document.getElementById('dPrio');
    if(!sel) return;
    var map = {
      // All
      "all": "All", "tất cả": "All", "tat ca": "All", "すべて": "All",
      // High
      "high": "High", "cao": "High", "高": "High",
      // Medium
      "medium": "Medium", "vừa": "Medium", "vua": "Medium", "中": "Medium",
      // Low
      "low": "Low", "thấp": "Low", "thap": "Low", "低": "Low"
    };
    Array.prototype.forEach.call(sel.options, function(opt){
      var t = norm(opt.textContent || opt.label || opt.value);
      if(map[t]) opt.value = map[t];
    });
    if(["All","High","Medium","Low"].indexOf(sel.value) === -1){
      // default to All
      var optAll = Array.prototype.find.call(sel.options, function(o){
        var t = norm(o.textContent || o.label || o.value);
        return ["all","tất cả","tat ca","すべて"].indexOf(t) !== -1 || o.value==="All";
      });
      if(optAll) sel.value = optAll.value || "All";
      else sel.value = "All";
    }
  }

  function ensureDeptNotEmpty(){
    var tbody = document.querySelector('#page-department #deptRows');
    if(tbody && tbody.children.length===0 && typeof window.renderDeptTable==='function'){
      try{ window.renderDeptTable(); }catch(e){}
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(function(){
      normalizeDeptPriorityValues();
      ensureDeptNotEmpty();
    }, 50);
  });

  window.addEventListener('ecn_lang_changed', function(){
    setTimeout(function(){
      normalizeDeptPriorityValues();
      ensureDeptNotEmpty();
    }, 60);
  });
})();
</script>

</body>
</html>
